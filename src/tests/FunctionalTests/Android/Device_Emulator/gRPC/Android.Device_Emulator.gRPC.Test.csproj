<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TestRuntime>true</TestRuntime>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <MainLibraryFileName>Android.Device_Emulator.gRPC.Test.dll</MainLibraryFileName>
    <ExpectedExitCode>42</ExpectedExitCode>

    <MonoForceInterpreter>false</MonoForceInterpreter>
    <RunAOTCompilation>true</RunAOTCompilation>
    <ForceAOT>true</ForceAOT>
    <AOTWithLibraryFiles>true</AOTWithLibraryFiles>

    <PublishTrimmed>true</PublishTrimmed>
    <EnableAggressiveTrimming>true</EnableAggressiveTrimming>
    
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <!-- Disable CS8981 because the generated code from the protobuf files contains classes with lowercase names -->
    <!-- Disable SYSLIB0039 because the tests intentionally use TLS 1.0 and 1.1 -->
    <NoWarn>CS8981;SYSLIB0039</NoWarn>
    <!-- The destination for the code of the grpc/grpc-dotnet repo -->
    <GrpcDotnetBasePath>$(MSBuildProjectDirectory)\grpc-dotnet</GrpcDotnetBasePath>
    <!-- We pretend to be Blazor WASM so that we don't have to modify the code of grpc-dotnet -->
    <!-- The pieces of code that Android needs to skips are the same as WASM -->
    <DefineConstants>BLAZOR_WASM</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="Program.cs" />
  </ItemGroup>

  <Import Project="$(GrpcDotnetBasePath)\build\dependencies.props"/>

  <!-- Based on grpc-dotnet's testassets/InteropTestsClient/InteropTestsClient.csproj -->
  <ItemGroup>
    <!-- Required for QUIC & HTTP/3 in .NET 6 - https://github.com/dotnet/runtime/pull/55332 -->
    <RuntimeHostConfigurationOption Include="System.Net.SocketsHttpHandler.Http3Support" Value="true" />

    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\Assert.cs" Link="Assert.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\AsyncStreamExtensions.cs" Link="AsyncStreamExtensions.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\ExceptionAssert.cs" Link="ExceptionAssert.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\IChannelWrapper.cs" Link="IChannelWrapper.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\InteropClient.cs" Link="InteropClient.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\testassets\Shared\TestCredentials.cs" Link="TestCredentials.cs" />
    <Compile Include="$(GrpcDotnetBasePath)\test\Shared\HttpEventSourceListener.cs" Link="HttpEventSourceListener.cs" />

    <Protobuf Include="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\test.proto" GrpcServices="Client" Link="Protos\test.proto" ProtoRoot="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\" />
    <Protobuf Include="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\empty.proto" GrpcServices="None" Link="Protos\empty.proto" ProtoRoot="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\" />
    <Protobuf Include="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\messages.proto" GrpcServices="None" Link="Protos\messages.proto" ProtoRoot="$(GrpcDotnetBasePath)\testassets\Proto\grpc\testing\" />

    <None Include="$(GrpcDotnetBasePath)\testassets\Certs\InteropTests\*.*" LinkBase="Certs">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>

    <PackageReference Include="Grpc.Auth" Version="$(GrpcPackageVersion)" />
    <PackageReference Include="Grpc.Net.Client" Version="$(GrpcPackageVersion)" />
    <PackageReference Include="Grpc.Net.Client.Web" Version="$(GrpcPackageVersion)" />

    <PackageReference Include="Google.Protobuf" Version="$(GoogleProtobufPackageVersion)" />
    <PackageReference Include="Grpc.Core" Version="$(GrpcPackageVersion)" PrivateAssets="All" />
    <PackageReference Include="Grpc.Tools" Version="$(GrpcPackageVersion)" PrivateAssets="All" />
    <PackageReference Include="Microsoft.Extensions.Logging" Version="$(MicrosoftExtensionsPackageVersion)" />
    <PackageReference Include="Newtonsoft.Json" Version="$(NewtonsoftJsonPackageVersion)" />
    <PackageReference Include="System.CommandLine" Version="$(SystemCommandLinePackageVersion)" />
    <PackageReference Include="System.Net.Http.WinHttpHandler" Version="$(SystemNetHttpWinHttpHandlerPackageVersion)" />
  </ItemGroup>

  <Target Name="_GitCloneGrpcDotnet" BeforeTargets="Restore">
    <RemoveDir Directories="$(GrpcDotnetBasePath)" />
    <Exec Command="git clone --depth 1 https://github.com/grpc/grpc-dotnet.git $(GrpcDotnetBasePath)"
          WorkingDirectory="$(MSBuildProjectDirectory )"
          IgnoreStandardErrorWarningFormat="true" />
  </Target>
</Project>
